image: creatiwww/docker-compose:latest

services:
  - docker:dind

variables:
  PROD_SERVER_IP: 185.148.83.32
  PROD_SERVER_USER: user
  PROD_IMAGE_FRONTEND_TAG: registry.gitlab.com/g4687/gute.tech-frontend/frontend:prod

stages:
  - release
  - deploy

release:
  stage: release
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_BUILD_TOKEN $CI_REGISTRY_IMAGE
    - echo "IMAGE_FRONTEND_TAG=$PROD_IMAGE_FRONTEND_TAG" >> .env
    - docker-compose build
    - docker-compose push
  only:
    - main

deploy-to-prod:
  stage: deploy
  script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PROD_SERVER_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - docker login -u $CI_REGISTRY_USER -p $CI_BUILD_TOKEN $CI_REGISTRY_IMAGE
    - echo "IMAGE_FRONTEND_TAG=$PROD_IMAGE_FRONTEND_TAG" >> .env
    - docker-compose -H "ssh://$PROD_SERVER_USER@$PROD_SERVER_IP" down --remove-orphans
    - docker-compose -H "ssh://$PROD_SERVER_USER@$PROD_SERVER_IP" pull
    - docker-compose -H "ssh://$PROD_SERVER_USER@$PROD_SERVER_IP" up -d
  only:
    - main
  when: manual